.. DecodeAndSort.rst --- 
.. 
.. Description: 
.. Author: Hongyi Wu(吴鸿毅)
.. Email: wuhongyi@qq.com 
.. Created: 日 9月  8 23:12:47 2024 (+0800)
.. Last-Updated: 六 1月 10 22:51:19 2026 (+0800)
..           By: Hongyi Wu(吴鸿毅)
..     Update #: 4
.. URL: http://wuhongyi.cn 

##################################################
Decoder
##################################################

============================================================
Decoding operation
============================================================


**The DecodeAndSortAll program is used to convert data recored by different modules one run into a ROOT file. The user's physical analysis is based on the ROOT file generated by this program. The data generated by this program has been arranged in ascending order of timestamp.**


The user first needs to modify the definition in the **UesrDefine.hh** file


.. code:: cpp

  // #define ONLYPHA
  // #define ONLYPSD
  // #define ONLYZLE
  // #define ONLYSCOPE


If all modules in the DAQ only use one type of firmware, enable the corresponding definition. If there is no definition of a single firmware, the output data file will default to supporting all types of firmware.


.. code:: cpp

  #define ROOTFILEPATH "./"       //the path of ROOT file
  #define ROOTFILENAME "data"     //the name of ROOT file
  // The path and file name for ROOT files


  
.. code:: cpp

  #define RAWFILEPATH "/home/wuhongyi/"      //Path of raw data
  #define RAWFILENAME "data"                 //The file name of the raw data
  #define MODNUMBER 2                        //Number of modules used in the chassis
  const unsigned short SamplingRate[MODNUMBER] = {500, 125};//Specify the sampling rate of each modules separately; 125/500/1000 sampling rates; 0 to skip the module
  const unsigned short Firmware[MODNUMBER] = {2, 0};//DPP_PHA=0 DPP_ZLE=1 DPP_PSD=2 DPP_DAW=3 OPEN=4 Scope=5
  // Specify the firmware type for each module. If the type is specified incorrectly, there will be issues decoding the data



After modification, execute the following command to compile the program:
  
.. code:: bash
	  
  make clean
  make


After successful compilation, an executable file **decodeandsort** will be generated, and the program will run as follows:

.. code:: bash

  ./decodeandsort [RunNnumber] 

Among them, *[RunNnumber]* is the running number of the file you want to convert.


--------------------------

============================================================
Data Format
============================================================

The decoded ROOT file contains a TTree with the following branches:

- Br	0 :sr	     : sr/s
   - Sampling rate, 125/500/1000
- Br	1 :fw	    : fw/s
   - Firmware type, DPP_PHA=0 DPP_ZLE=1 DPP_PSD=2 DPP_DAW=3 DPP_OPEN=4 Scope/SCOPE_OPEN=5
- Br	2 :mod	    : mod/s
   - Module number, starting from 0
- Br	3 :ch	    : ch/s
   - Channel number
- Br	4 :ts	    : ts/L
   - Timestamp, unit in ns
- Br	5 :finets    : finets/s
   - Fine timestamp for PSD firmware, 0-1023
- Br	6 :flagslow  : flagslow/s
- Br	7 :flagshigh : flagshigh/s
- Br	8 :energy    : energy/s
   - Energy for PHA firmware, long-gate energy for PSD firmware
- Br	9 :energyshort : energyshort/s
   - Short-gate energy for PSD firmware
- Br   10 :samples   : samples/s
   - Number of samples for PHA/PSD firmware ADCINPUT waveform mode
- Br   11 :analog0   : analog0[samples]/I
- Br   12 :analog1   : analog1[samples]/I
- Br   13 :digital0  : digital0[samples]/O
- Br   14 :digital1  : digital1[samples]/O
- Br   15 :digital2  : digital2[samples]/O
- Br   16 :digital3  : digital3[samples]/O
- Br   17 :analogtypes : analogtypes[2]/s
- Br   18 :digitaltypes : digitaltypes[4]/s
- Br   19 :triggerid : triggerid/i
- Br   20 :nsamples  : nsamples/i
   - Waveform length recorded by scope / ZLE / PHA/PSD ADCINPUT16 / OPENDPP
- Br   21 :waveform  : waveform[nsamples]/s
- Br   22 :info	    : info/s
   - Firmware type for OPENFDK, where 0 is PHA+PSD, 1 is PHA+CFD
- Br   23 :energyxia : energyxia/s
   - Energy for OPENFDK firmware, calculated using XIA's three-segment integration algorithm
- Br   24 :flagcfd   : flagcfd/O
   - Indicates whether the CFD for OPENFDK firmware is valid
- Br   25 :cfdxia    : cfdxia/D
   - CFD value for OPENFDK firmware, unit in ns. ts + cfdxia gives the absolute time.
- Br   26 :flagpsd   : flagpsd/O
   - Indicates whether the PSD for OPENFDK firmware is valid
- Br   27 :psdcc	    : psdcc/D
   - Charge comparison method PSD for OPENFDK firmware
- Br   28 :psdcostheta : psdcostheta/D
   - Cosine similarity PSD for OPENFDK firmware



PHA/PSD data structure

**flahshigh**

- bit 0 Pile-Up
   - Identifies pile-up events, ie two events in which the second one occurred before the Peaking Time of the first one. Both are then tagged as pile-up because it's not possible to evaluate their energy. See EnergyFilterPeakingPosition
- bit 1 Pile-up rejector guard event
   - Identifies an event occurred during the pile-up rejector guard window. See EnergyFilterPileUpGuardT, EnergyFilterPileUpGuardS. There are cases in which both such bits can be '1': if an event ccurs in the pile-up rejector guard of the previous one and does not reach the peaking time because another event has occurred, then such event will have both bits at 1. This allows, with the same data and without doing two separate acquisitions, to have two spectra: one corrected for the PUR guard and one not corrected
- bit 2 Event Saturation
   - Identifies an event in which a saturation of the input dynamics occurred
- bit 3 Post saturation event
   - Identifies an event occurred during the ADCVetoWidth time
- bit 4 Trapezoid saturation event
   - Identifies an event in which a saturation of the trapezoid occurred.
- bit 5 SCA selected event
   - Identifies an event falling within the SCA windows (if enabled).


**flahslow**

- bit 0 Event waveform occurred during external inhibit
   - Identifies a saved waveform because occurred when the external inhibit is active (useful in case of Transistor Reset Preamplifier detector use to see what happens during the reset).
- bit 1 Event waveform under-saturation
   - Identifies a saved waveform because under-saturating
- bit 2 Event waveform oversaturation
   - Identifies a saved waveform because over-saturating
- bit 3 External trigger
   - Identifies an event triggered by the external trigger from the TRG-IN connector
- bit 4 Global trigger
   - Identifies an event triggered by a global trigger condition
- bit 5 Software trigger
   - Identifies an event triggered by a software trigger
- bit 6 Self trigger
   - Identifies an event triggered by the single channel self trigger
- bit 7 LVDS trigger
   - Identifies an event triggered by the external trigger from the LVDS connector
- bit 8 64 channel trigger
   - Identifies an event triggered by another (or a combination of other) channels trigger
- bit 9 ITLA trigger
   - Identifies an event triggered by the ITLA logic
- bit 10 ITLB trigger
   - Identifies an event triggered by the ITLB logic










.. 
.. DecodeAndSort.rst ends here
